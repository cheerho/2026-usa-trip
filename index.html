<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>2026 USA Family Trip</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.13.3/dist/cdn.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">

    <style>
        :root { --earth-red: #A67B71; --earth-yellow: #D9B48F; --earth-bg: #F5F2EE; --text-main: #3D3530; --jp-white: #FFFFFF; }
        body { font-family: -apple-system, "PingFang TC", sans-serif; background: var(--earth-bg); color: var(--text-main); -webkit-tap-highlight-color: transparent; overflow-x: hidden; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        
        .date-slider { display: flex; overflow-x: auto; gap: 12px; padding: 20px; -webkit-overflow-scrolling: touch; scrollbar-width: none; }
        .date-card { flex: 0 0 75px; text-align: center; padding: 14px 0; border-radius: 20px; background: var(--jp-white); border: 1px solid #E5E1DA; transition: 0.2s; cursor: pointer; }
        .date-card.active { background: var(--earth-red); color: white; border-color: var(--earth-red); transform: translateY(-2px); box-shadow: 0 8px 15px rgba(166, 123, 113, 0.2); }
        .date-num { font-size: 20px; font-weight: 800; line-height: 1; margin-bottom: 4px; }

        .nav-overlay { position: absolute; bottom: -24px; right: 24px; display: flex; gap: 12px; z-index: 40; }
        .nav-btn { width: 52px; height: 52px; border-radius: 50%; background: var(--jp-white); color: var(--earth-red); display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 15px rgba(0,0,0,0.08); border: none; cursor: pointer; transition: 0.2s; }
        .nav-btn.active { background: var(--earth-yellow); color: white; transform: scale(1.1); }

        .timeline-row { display: flex; gap: 16px; margin-bottom: 24px; cursor: pointer; padding: 0 4px; }
        .time-col { display: flex; flex-direction: column; align-items: center; width: 55px; flex-shrink: 0; }
        .time-text { font-size: 17px; font-weight: 900; color: var(--text-main); }
        .time-line { width: 2px; flex-grow: 1; background: #E5E1DA; margin-top: 8px; border-radius: 2px; }
        .content-col { flex-grow: 1; background: var(--jp-white); padding: 16px; border-radius: 22px; box-shadow: 0 2px 12px rgba(0,0,0,0.01); border: 1px solid rgba(0,0,0,0.03); }

        /* 住宿卡片專屬樣式 */
        .stay-card { background: #334155; color: white; padding: 20px; border-radius: 24px; margin-top: 10px; box-shadow: 0 8px 20px rgba(51,65,85,0.2); }
        .stay-title { font-size: 11px; font-weight: 900; color: var(--earth-yellow); text-transform: uppercase; letter-spacing: 2px; margin-bottom: 8px; }
        .stay-name { font-size: 18px; font-weight: 800; line-height: 1.3; }
        .stay-link-btn { display: inline-flex; align-items: center; gap: 6px; background: rgba(255,255,255,0.1); padding: 8px 16px; border-radius: 12px; font-size: 12px; margin-top: 12px; color: white; text-decoration: none; border: 1px solid rgba(255,255,255,0.1); }

        /* 航班字體強化 */
        .flight-card { background: #334155; color: white; border-radius: 28px; padding: 24px; margin-bottom: 20px; }
        .flight-iata-term { font-size: 16px; font-weight: 600; color: #FFF; opacity: 0.9; margin-top: 4px; }

        .add-exp-btn { position: fixed; bottom: 40px; right: 25px; width: 64px; height: 64px; border-radius: 50%; background: #EF4444; color: white; display: flex; align-items: center; justify-content: center; font-size: 24px; box-shadow: 0 10px 25px rgba(239, 68, 68, 0.4); z-index: 90; border: none; cursor: pointer; }
        [x-cloak] { display: none !important; }
    </style>
</head>
<body x-data="travelApp()" x-init="init()">

    <div class="relative h-64 bg-cover bg-center" style="background-image: url('https://images.unsplash.com/photo-1436491865332-7a61a109c055?q=80&w=1200');">
        <div class="absolute inset-0 bg-stone-900/40"></div>
        <div class="absolute top-24 left-8 text-white">
            <h1 class="text-3xl font-black tracking-tight flex items-end gap-2">2026 USA Trip<span class="text-[10px] font-medium opacity-50 mb-1">v15.3</span></h1>
            <p class="text-[9px] font-bold opacity-70 uppercase tracking-[0.4em] mt-2">Canyon Expedition</p>
        </div>
        <div class="nav-overlay">
            <button @click="currentTab = 'itinerary'" :class="currentTab==='itinerary'?'active':''" class="nav-btn"><i class="fas fa-map-marker-alt"></i></button>
            <button @click="currentTab = 'info'" :class="currentTab==='info'?'active':''" class="nav-btn"><i class="fas fa-plane"></i></button>
            <button @click="currentTab = 'expense'" :class="currentTab==='expense'?'active':''" class="nav-btn"><i class="fas fa-wallet"></i></button>
        </div>
    </div>

    <main class="p-6 pb-40">
        <div x-show="currentTab === 'itinerary'" x-transition>
            <div class="date-slider mb-6 no-scrollbar">
                <template x-for="d in dates" :key="d.full">
                    <div @click="activeDate = d.full" :class="activeDate === d.full ? 'active' : ''" class="date-card">
                        <div class="date-num" x-text="d.dayOnly"></div>
                        <div class="date-day" x-text="d.weekday"></div>
                    </div>
                </template>
            </div>
            
            <div id="event-list">
                <template x-for="(event, index) in filteredEvents" :key="index">
                    <div class="timeline-row" @click="openDetail(event)">
                        <div class="time-col">
                            <span class="time-text" x-text="event.time || '--'"></span>
                            <div class="time-line"></div>
                        </div>
                        <div class="content-col active:scale-95 transition-transform">
                            <h3 class="text-xl font-black text-stone-800 leading-tight mb-2" x-text="event.name"></h3>
                            <p class="text-xs text-stone-400 font-medium line-clamp-2" x-text="event.note"></p>
                        </div>
                    </div>
                </template>

                <div x-show="currentStay" class="mt-8 ml-[55px] relative">
                    <div class="absolute -left-[30px] top-0 bottom-0 w-[2px] border-l-2 border-dashed border-stone-300"></div>
                    
                    <div class="stay-card">
                        <div class="stay-title"><i class="fas fa-bed mr-2"></i>Tonight's Stay</div>
                        <div class="stay-name" x-text="currentStay.name"></div>
                        
                        <template x-if="currentStay.link">
                            <a :href="currentStay.link" target="_blank" class="stay-link-btn">
                                <i class="fas fa-external-link-alt"></i> 檢視訂房資訊
                            </a>
                        </template>

                        <div class="mt-4 grid grid-cols-2 gap-4 border-t border-white/10 pt-4">
                            <div>
                                <div class="text-[9px] opacity-40 uppercase">Check-in</div>
                                <div class="text-xs font-bold">15:00 之後</div>
                            </div>
                            <div>
                                <div class="text-[9px] opacity-40 uppercase">Google Maps</div>
                                <button @click="window.open('https://www.google.com/maps/search/'+encodeURIComponent(currentStay.name), '_blank')" class="text-xs font-bold text-earth-yellow underline">開啟導航</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div x-show="currentTab === 'info'" x-cloak x-transition class="space-y-6">
            <template x-for="f in flightList" :key="f.no">
                <div class="flight-card shadow-xl">
                    <div class="text-[10px] font-black text-earth-yellow mb-4" x-text="f.airline + ' • ' + f.no"></div>
                    <div class="flex justify-between items-start text-center">
                        <div class="flex-1 text-left">
                            <div class="text-xl font-black" x-text="f.fromC"></div>
                            <div class="flight-iata-term" x-text="f.fromE + ' ' + f.fromT"></div>
                            <div class="mt-4"><div class="text-[10px] opacity-40" x-text="f.depD"></div><div class="text-lg font-bold text-earth-yellow" x-text="f.depT"></div></div>
                        </div>
                        <div class="flex-1 flex flex-col items-center pt-2">
                            <div class="text-3xl font-light opacity-30">→</div>
                            <div class="text-[9px] font-black uppercase text-earth-yellow mt-1" x-text="f.dur"></div>
                        </div>
                        <div class="flex-1 text-right">
                            <div class="text-xl font-black" x-text="f.toC"></div>
                            <div class="flight-iata-term" x-text="f.toE + ' ' + f.toT"></div>
                            <div class="mt-4"><div class="text-[10px] opacity-40" x-text="f.arrD"></div><div class="text-lg font-bold text-earth-yellow" x-text="f.arrT"></div></div>
                        </div>
                    </div>
                </div>
            </template>
        </div>
    </main>

    <button x-show="currentTab === 'expense'" class="add-exp-btn" x-transition x-cloak><i class="fas fa-plus"></i></button>

    <script>
        function travelApp() {
            return {
                currentTab: 'itinerary',
                activeDate: '2026/05/03',
                dates: [],
                events: [],
                flightList: [
                    { no: "UA872", airline: "聯合航空", fromC: "台北", fromE: "TPE", fromT: "T2", toC: "舊金山", toE: "SFO", toT: "I", depD: "05/03", depT: "09:50", arrD: "05/03", arrT: "06:25", dur: "11h 35m" },
                    { no: "UA18", airline: "聯合航空", fromC: "舊金山", fromE: "SFO", fromT: "T3", toC: "台北", toE: "TPE", toT: "T2", depD: "05/16", depT: "14:10", arrD: "05/18", arrT: "18:45", dur: "13h 35m" }
                ],
                async init() {
                    this.dates = this.generateDates();
                    await this.refreshAll();
                },
                generateDates() {
                    let dArr = [], s = new Date(2026, 4, 3), e = new Date(2026, 4, 18);
                    while(s <= e) {
                        let m = String(s.getMonth() + 1).padStart(2, '0'), day = String(s.getDate()).padStart(2, '0');
                        dArr.push({ full: `${s.getFullYear()}/${m}/${day}`, dayOnly: day, weekday: ['SUN', 'MON', 'TUE', 'WED', 'THU', 'FRI', 'SAT'][s.getDay()] });
                        s.setDate(s.getDate() + 1);
                    }
                    return dArr;
                },
                get filteredEvents() { return this.events.filter(e => e.date === this.activeDate); },
                
                // 智慧抓取當前日期的最後一個住宿資訊
                get currentStay() {
                    let dayEvents = this.filteredEvents;
                    if (dayEvents.length === 0) return null;
                    // 找到該天最後一個填有「住宿」欄位的內容
                    let lastWithStay = [...dayEvents].reverse().find(e => e.stay && e.stay.trim() !== "");
                    if (!lastWithStay) return null;
                    
                    let stayContent = lastWithStay.stay;
                    let urlRegex = /(https?:\/\/[^\s]+)/g;
                    let url = stayContent.match(urlRegex);
                    
                    return {
                        name: stayContent.replace(urlRegex, '').trim() || "住宿地點",
                        link: url ? url[0] : null
                    };
                },

                async refreshAll() {
                    const ts = new Date().getTime();
                    const url = `https://docs.google.com/spreadsheets/d/e/2PACX-1vTCDL1TfyD_VsfRPWQxEUovWSnLZmpUzAKrZr-ni7BIJ8DgrKWxPGRywUCv7Eu6j-rSbcdPZbG4kiX1/pub?gid=1750147690&single=true&output=csv&t=${ts}`;
                    Papa.parse(url, {
                        download: true, header: true,
                        complete: (r) => {
                            let lastDate = "";
                            this.events = r.data.map(row => {
                                let d = row.日期;
                                if (!d || d.trim() === "") { d = lastDate; } 
                                else {
                                    let p = d.match(/\d+/g);
                                    if(p && p.length >= 2) {
                                        let y = p.length === 3 ? p[0] : '2026', m = (p.length === 3 ? p[1] : p[0]).padStart(2, '0'), day = (p.length === 3 ? p[2] : p[1]).padStart(2, '0');
                                        d = `${y}/${m}/${day}`;
                                    }
                                    lastDate = d;
                                }
                                return { date: d, time: row.時間, name: row.行程, note: row.備註, stay: row.住宿 };
                            });
                        }
                    });
                },
                openDetail(e) { /* 保留原有詳細頁邏輯 */ }
            }
        }
    </script>
</body>
</html>
